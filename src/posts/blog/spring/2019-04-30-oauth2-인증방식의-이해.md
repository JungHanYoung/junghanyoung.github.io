---
title: "Springì— OAuth2 ë¡œê·¸ì¸"
date: "2019-04-30"
tags: ["oauth2", "google", "facebook", "github"]
---

> ë‚´ ë§˜ëŒ€ë¡œ ì •ë¦¬ì´ë‹ˆ ğŸ¶ì†Œë¦¬ê°€ ì„ì—¬ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ ì €ëŠ” ë§ëŠ” ë§ë§Œ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë‹ˆ ì²˜ìŒ ë³´ì‹œëŠ” ë¶„ì€ í¸í•˜ê²Œ ë´ì£¼ì‹œê¸¸..
>
> í”¼ë“œë°±ì€ ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤ã… ã…  ì €ì—ê²Œ ê³µë¶€ê°€ ë©ë‹ˆë‹¤!


## OAuth2 ì¸ì¦ë°©ì‹ì˜ ì´í•´

Google, Facebook, Twiterì™€ ê°™ì€ ì„œë¹„ìŠ¤ì— íšŒì›ì¸ì¦ì„ ìœ„ì„í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì¸ì¦ë°©ì‹. ì‚¬ìš©ìì˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ ê°œë°œí•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ì• ì´ˆì— ì ‘ê·¼í•˜ì§€ ì•Šê³  OAuth2 ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì œê³µìì— ìœ„ì„í•˜ë¯€ë¡œ ì±…ì„ì„ ì¢€ë” íšŒí”¼í•  ìˆ˜ ìˆê²Œ ë¨.


### OAuth2ì˜ ì¸ì¦ë°©ì‹ Flow

- User(ì‚¬ìš©ì)
- ê°œë°œì¤‘ì¸ ì„œë¹„ìŠ¤
- OAuth2ë¥¼ ì§€ì›í•˜ëŠ” ì œê³µì (google, facebook, ...ë“±ë“±)

1. ë¨¼ì € Userê°€ Aë¡œ ë¶€í„° google ë¡œê·¸ì¸ì„ ì‹œë„.
2. AëŠ” googleì— ë¡œê·¸ì¸í¼ì„ ìš”ì²­, ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•œë‹¤.
3. UserëŠ” google ë¡œê·¸ì¸í¼ í™•ì¸.
4. google ë¡œê·¸ì¸.
5. googleì€ í•´ë‹¹ ì •ë³´ ì¸ì¦.
6. ì¸ì¦ë˜ë©´ googleì€ Aì— access_tokenì„ ë°œê¸‰.
7. AëŠ” í•´ë‹¹ í† í°ì„ í†µí•´ ì¸ì¦í™•ì¸
    - ì´ì œ ì„¸ì…˜ì— í† í°ì„ ê°€ì§€ê³  ìˆë˜ì§€ cookieë¡œ í† í°ë°œê¸‰í•˜ê²Œ í•˜ë˜ì§€ ã…‡ã…‡

ì—¬ê¸°ì„œ ê°œë°œë˜ëŠ” ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ìì˜ google ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ì—†ê²Œ ë˜ì–´ìˆë‹¤.

ì¼ë‹¨ ì´ë ‡ê²Œ ì •ë¦¬ê°€ ë˜ëŠ”ë° ë³´í†µ ë°±ì—”ë“œì—ì„œ ì½”ë“œë¥¼ êµ¬í˜„í•  ë•Œì—ëŠ” flow(íë¦„)ë¥¼ ì•„ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ ìš©ì–´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì–´ë–»ê²Œ ì“°ëŠ”ì§€ê°€ ì¤‘ìš”í•´ë³´ì„. flowëŠ” ê¸°ë³¸ì ì¸ ê²ƒ..


### Spring Bootì—ì„œ êµ¬í˜„í•˜ê¸°.

ì´ëŠ” ì•„ì§ ì´í•´ê°€ ì•ˆë˜ì–´ìˆìœ¼ë‹ˆ ì¼ë‹¨ ì´í•´ê°€ ëœ ë¶€ë¶„ë¶€í„° ì°¨ë¡€ë¡œ ì •ë¦¬í•˜ë„ë¡ í•˜ê² ìŒ.


#### êµ¬í˜„í•˜ê¸° ì „ì— ì •ë¦¬í•  ìš©ì–´ë“¤

- Authorization: í—ˆê°€ - ë¡œê·¸ì¸ í›„ í•´ë‹¹ íšŒì›ì˜ ì¸ì¦ í—ˆê°€ë¥¼ ì£¼ëŠ” ê²ƒ. - ì•¡ì„¸ìŠ¤í† í° í™•ì¸?
- Authentication: ì¸ì¦ - ë¡œê·¸ì¸ 

#### êµ¬í˜„

- Spring Boot
- Spring Security
- Spring Security OAuth2

##### ì‹œíë¦¬í‹° ì„¤ì •

- ì‹œíë¦¬í‹° ì„¤ì •ì—ì„œ http configureë©”ì†Œë“œë¥¼ êµ¬í˜„í• ë•Œ oauth2Login()ì—ì„œë¶€í„° ì‹œì‘ëœë‹¤.
    - oauth2Loginìœ¼ë¡œ ë¶™ëŠ” ë©”ì†Œë“œëŠ”
        - authorizationEndpoint: ì•¡ì„¸ìŠ¤í† í°ì„ ì¸ì¦í•˜ëŠ” ê³³..?
        - authorizationRequestRepository: ì¸ì¦ìš”ì²­ì„ ì €ì¥í•  ì €ì¥ì†Œ..?
        - redirectionEndpoint: OAuth2 ë¡œê·¸ì¸ì„ ì„±ê³µí•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë  ê³³
        - userInfoEndpoint: OAuth2 ì¸ì¦í›„ ì‚¬ìš©ìì •ë³´ë¥¼ loadí•˜ëŠ” ê³³
            - OAuth2UserService
        - successHandler: ìœ ì €ì •ë³´ê¹Œì§€ ì„±ê³µì ìœ¼ë¡œ loadë˜ë©´ ì‹¤í–‰ë  í•¸ë“¤ëŸ¬
        - FailureHandler: ë„ì¤‘ Exceptionì„ ë°›ì„ í•¸ë“¤ëŸ¬

ëŒ€~ì¶© ì´ëŸ°ë° ë§ëŠ” ì§€ ì˜ ëª¨ë¥´ê²Ÿë‹¤. ì¢€ ë” ì½”ë“œë¥¼ ë’¤ì§‘ì–´ê¹Œë´ì•¼ë ê±°ê°€í‹ˆ.

##### OAuth2UserService 

í† í°ì„ ë°œê¸‰ë°›ê³ , ìœ ì €ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ê³¼ì •ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ë¡œ ë³´ì¸ë‹¤.

- OAuth2ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ë©´, í•´ë‹¹ ì„œë¹„ìŠ¤ë¡œ ìœ ì €ì •ë³´ ì¡°íšŒ - ì‹œíë¦¬í‹°ì„¤ì •ì—ì„œ userInfoEndpointì— ì¶”ê°€í•œ ê²ƒìœ¼ë¡œ ì´ë ‡ê²Œ ì¶”ì¸¡ë˜ì–´ì§.

```java
@Service
@RequiredArgsConstructor
public class CustomOAuth2UserService extends DefaultOAuth2UserService {

    private final UserRepository userRepository;

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(userRequest);

        try {
            return processOAuth2User(userRequest, oAuth2User);
        } catch(Exception ex) {
            throw new InternalAuthenticationServiceException(ex.getMessage(), ex.getCause());
        }
    }

    private OAuth2User processOAuth2User(OAuth2UserRequest oAuth2UserRequest, OAuth2User oAuth2User) {
        OAuth2UserInfo oAuth2UserInfo = OAuth2UserInfoFactory.getOAuth2UserInfo(oAuth2UserRequest.getClientRegistration().getRegistrationId(), oAuth2User.getAttributes());
        if(StringUtils.isEmpty(oAuth2UserInfo.getEmail())) {
            throw new OAuth2AuthenticationProcessingException("Email not found from OAuth2 provider");
        }

        Optional<User> userOptional = userRepository.findByEmail(oAuth2UserInfo.getEmail());
        User user;
        if(userOptional.isPresent()) {
            user = userOptional.get();
            if(!user.getProvider().equals(AuthProvider.valueOf(oAuth2UserRequest.getClientRegistration().getRegistrationId()))) {
                throw new OAuth2AuthenticationProcessingException("Looks like you're signed up with "
                        + user.getProvider() + " account, Please use your " + user.getProvider() + " account to login");
            }
            user = updateExistingUser(user, oAuth2UserInfo);
        } else {
            user = registerNewUser(oAuth2UserRequest, oAuth2UserInfo);
        }

        return UserPrincipal.create(user, oAuth2User.getAttributes());
    }

    private User registerNewUser(OAuth2UserRequest oAuth2UserRequest, OAuth2UserInfo oAuth2UserInfo) {

        User user = User.builder()
                .provider(AuthProvider.valueOf(oAuth2UserRequest.getClientRegistration().getRegistrationId()))
                .providerId(oAuth2UserInfo.getId())
                .name(oAuth2UserInfo.getName())
                .email(oAuth2UserInfo.getEmail())
                .imageUrl(oAuth2UserInfo.getImageUrl())
                .build();

        return userRepository.save(user);
    }

    private User updateExistingUser(User existingUser, OAuth2UserInfo oAuth2UserInfo) {
        existingUser.setName(oAuth2UserInfo.getName());
        existingUser.setImageUrl(oAuth2UserInfo.getImageUrl());
        return userRepository.save(existingUser);
    }
}
```

- DefaultOAuth2UserServiceìƒì†, ë¶€ëª¨í´ë˜ìŠ¤ì˜ loadUserì‹¤í–‰, ë¶ˆëŸ¬ë“¤ì¸ Userë¥¼ ê°€ì§€ê³  ì»¤ìŠ¤í„°ë§ˆì´ì§•

- ì–´ë– í•œ ê²ƒì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í–ˆëŠ”ê°€.
  - ìœ ì €ì •ë³´ì—ì„œ ì´ë©”ì¼ì„ ê°€ì§€ê³  DBì¡°íšŒ
  - ìœ ì €ê°€ ì¡´ì¬í•˜ê³  ì¡°íšŒëœ ê²ƒê³¼ ë¡œê·¸ì¸ ì„±ê³µí•œ ê²ƒê³¼ provider(google, facebookë“±)ë¥¼ ë¹„êµ, 
    - oauthëŠ” ë‹¬ë¼ë„ ì´ë©”ì¼ì´ ê°™ì„ ìˆ˜ ìˆìŒ. (í•„ìëŠ” google, github ì´ë©”ì¼ì´ ê°™ì•„ githubê³„ì •ì„ ëª»ë§Œë“¬.)
  - í•´ë‹¹ ìœ ì €ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥.


##### JWTí† í° ê²€ì¦ ë° ë°œê¸‰ ì²˜ë¦¬(TokenAuthenticationFilter)

- ë°œê¸‰ë°›ì€ í† í°ì´ ìœ íš¨í•œ í† í°ì¸ì§€ í™•ì¸í•´ì£¼ëŠ” í•„í„°

ì´ í•„í„°ëŠ” UsernamePasswordAuthenticationFilter í´ë˜ìŠ¤ ì•ì— ë‚˜ì˜¤ê²Œ í•˜ì—¬ ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ë³´ë‹¤ ë” ì•ì„œ OAuth2ë¡œê·¸ì¸ì„ í™•ì¸í•˜ê² ë‹¤ëŠ”(?) í•„í„°

```java
public class TokenAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private TokenProvider tokenProvider;
    @Autowired
    private CustomUserDetailsService customUserDetailsService;

    private static final Logger logger = LoggerFactory.getLogger(TokenAuthenticationFilter.class);

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {
        try {
            String jwt = getJwtFromRequest(request);

            if(StringUtils.hasText(jwt) && tokenProvider.validateToken(jwt)) {
                Long userId = tokenProvider.getUserIdFromToken(jwt);

                UserDetails userDetails = customUserDetailsService.loadUserById(userId);
                UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                SecurityContextHolder.getContext().setAuthentication(authenticationToken);
            }
        } catch (Exception ex) {
            logger.error("ìœ ì € ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        chain.doFilter(request, response);
    }

    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if(StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

1. Authorization í—¤ë”ë¡œ ë“¤ì–´ì˜¨ JWTí† í°ì„ ê²€ì¦.
2. ìœ ì € idë¡œ ìœ ì €ì •ë³´ë¥¼ ê°€ì ¸ì˜´(DBì—ì„œ ê°€ì ¸ì˜¤ê²Œ ë˜ì–´ìˆìŒ.)
3. ì¸ì¦í† í°ì„ ë§Œë“¬(UsernamePasswordAuthenticationToken)
4. í•´ë‹¹ í† í°ì„ í†µí•´ ì‹œíë¦¬í‹° contextì— ì¸ì¦ë˜ì—ˆë‹¤!ëŠ” ê²ƒì„ ì ìš©ì‹œì¼œ ë‹¤ìŒ UsernamePassword ì¸ì¦í•„í„°ì— ë§‰íˆì§€ì•Šê²Œí•¨.

