{"data":{"markdownRemark":{"id":"d980a891-2c91-5942-9e83-db7f847d9ed2","frontmatter":{"title":"OAuth2 ì¸ì¦ë°©ì‹ì˜ ì´í•´"},"html":"<blockquote>\n<p>ë‚´ ë§˜ëŒ€ë¡œ ì •ë¦¬ì´ë‹ˆ ğŸ¶ì†Œë¦¬ê°€ ì„ì—¬ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ ì €ëŠ” ë§ëŠ” ë§ë§Œ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë‹ˆ ì²˜ìŒ ë³´ì‹œëŠ” ë¶„ì€ í¸í•˜ê²Œ ë´ì£¼ì‹œê¸¸..</p>\n<p>í”¼ë“œë°±ì€ ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤ã… ã…  ì €ì—ê²Œ ê³µë¶€ê°€ ë©ë‹ˆë‹¤!</p>\n</blockquote>\n<h2 id=\"oauth2-ì¸ì¦ë°©ì‹ì˜-ì´í•´\"><a href=\"#oauth2-%EC%9D%B8%EC%A6%9D%EB%B0%A9%EC%8B%9D%EC%9D%98-%EC%9D%B4%ED%95%B4\" aria-label=\"oauth2 ì¸ì¦ë°©ì‹ì˜ ì´í•´ permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth2 ì¸ì¦ë°©ì‹ì˜ ì´í•´</h2>\n<p>Google, Facebook, Twiterì™€ ê°™ì€ ì„œë¹„ìŠ¤ì— íšŒì›ì¸ì¦ì„ ìœ„ì„í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì¸ì¦ë°©ì‹. ì‚¬ìš©ìì˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ ê°œë°œí•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ì• ì´ˆì— ì ‘ê·¼í•˜ì§€ ì•Šê³  OAuth2 ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì œê³µìì— ìœ„ì„í•˜ë¯€ë¡œ ì±…ì„ì„ ì¢€ë” íšŒí”¼í•  ìˆ˜ ìˆê²Œ ë¨.</p>\n<h3 id=\"oauth2ì˜-ì¸ì¦ë°©ì‹-flow\"><a href=\"#oauth2%EC%9D%98-%EC%9D%B8%EC%A6%9D%EB%B0%A9%EC%8B%9D-flow\" aria-label=\"oauth2ì˜ ì¸ì¦ë°©ì‹ flow permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth2ì˜ ì¸ì¦ë°©ì‹ Flow</h3>\n<ul>\n<li>\n<p>User(ì‚¬ìš©ì)</p>\n</li>\n<li>\n<p>ê°œë°œì¤‘ì¸ ì„œë¹„ìŠ¤</p>\n</li>\n<li>\n<p>OAuth2ë¥¼ ì§€ì›í•˜ëŠ” ì œê³µì (google, facebook, ...ë“±ë“±)</p>\n</li>\n<li>\n<p>ë¨¼ì € Userê°€ Aë¡œ ë¶€í„° google ë¡œê·¸ì¸ì„ ì‹œë„.</p>\n</li>\n<li>\n<p>AëŠ” googleì— ë¡œê·¸ì¸í¼ì„ ìš”ì²­, ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•œë‹¤.</p>\n</li>\n<li>\n<p>UserëŠ” google ë¡œê·¸ì¸í¼ í™•ì¸.</p>\n</li>\n<li>\n<p>google ë¡œê·¸ì¸.</p>\n</li>\n<li>\n<p>googleì€ í•´ë‹¹ ì •ë³´ ì¸ì¦.</p>\n</li>\n<li>\n<p>ì¸ì¦ë˜ë©´ googleì€ Aì— access_tokenì„ ë°œê¸‰.</p>\n</li>\n<li>\n<p>AëŠ” í•´ë‹¹ í† í°ì„ í†µí•´ ì¸ì¦í™•ì¸</p>\n<ol>\n<li>ì´ì œ ì„¸ì…˜ì— í† í°ì„ ê°€ì§€ê³  ìˆë˜ì§€ cookieë¡œ í† í°ë°œê¸‰í•˜ê²Œ í•˜ë˜ì§€ ã…‡ã…‡</li>\n</ol>\n</li>\n</ul>\n<p>ì—¬ê¸°ì„œ ê°œë°œë˜ëŠ” ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ìì˜ google ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ì—†ê²Œ ë˜ì–´ìˆë‹¤.</p>\n<p>ì¼ë‹¨ ì´ë ‡ê²Œ ì •ë¦¬ê°€ ë˜ëŠ”ë° ë³´í†µ ë°±ì—”ë“œì—ì„œ ì½”ë“œë¥¼ êµ¬í˜„í•  ë•Œì—ëŠ” flow(íë¦„)ë¥¼ ì•„ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ ìš©ì–´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì–´ë–»ê²Œ ì“°ëŠ”ì§€ê°€ ì¤‘ìš”í•´ë³´ì„. flowëŠ” ê¸°ë³¸ì ì¸ ê²ƒ..</p>\n<h3 id=\"spring-bootì—ì„œ-êµ¬í˜„í•˜ê¸°\"><a href=\"#spring-boot%EC%97%90%EC%84%9C-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"spring bootì—ì„œ êµ¬í˜„í•˜ê¸° permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spring Bootì—ì„œ êµ¬í˜„í•˜ê¸°.</h3>\n<p>ì´ëŠ” ì•„ì§ ì´í•´ê°€ ì•ˆë˜ì–´ìˆìœ¼ë‹ˆ ì¼ë‹¨ ì´í•´ê°€ ëœ ë¶€ë¶„ë¶€í„° ì°¨ë¡€ë¡œ ì •ë¦¬í•˜ë„ë¡ í•˜ê² ìŒ.</p>\n<h4 id=\"êµ¬í˜„í•˜ê¸°-ì „ì—-ì •ë¦¬í• -ìš©ì–´ë“¤\"><a href=\"#%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0-%EC%A0%84%EC%97%90-%EC%A0%95%EB%A6%AC%ED%95%A0-%EC%9A%A9%EC%96%B4%EB%93%A4\" aria-label=\"êµ¬í˜„í•˜ê¸° ì „ì— ì •ë¦¬í•  ìš©ì–´ë“¤ permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>êµ¬í˜„í•˜ê¸° ì „ì— ì •ë¦¬í•  ìš©ì–´ë“¤</h4>\n<ul>\n<li>Authorization: í—ˆê°€ - ë¡œê·¸ì¸ í›„ í•´ë‹¹ íšŒì›ì˜ ì¸ì¦ í—ˆê°€ë¥¼ ì£¼ëŠ” ê²ƒ. - ì•¡ì„¸ìŠ¤í† í° í™•ì¸?</li>\n<li>Authentication: ì¸ì¦ - ë¡œê·¸ì¸ </li>\n</ul>\n<h4 id=\"êµ¬í˜„\"><a href=\"#%EA%B5%AC%ED%98%84\" aria-label=\"êµ¬í˜„ permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>êµ¬í˜„</h4>\n<ul>\n<li>Spring Boot</li>\n<li>Spring Security</li>\n<li>Spring Security OAuth2</li>\n</ul>\n<h5 id=\"ì‹œíë¦¬í‹°-ì„¤ì •\"><a href=\"#%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0-%EC%84%A4%EC%A0%95\" aria-label=\"ì‹œíë¦¬í‹° ì„¤ì • permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì‹œíë¦¬í‹° ì„¤ì •</h5>\n<ul>\n<li>\n<p>ì‹œíë¦¬í‹° ì„¤ì •ì—ì„œ http configureë©”ì†Œë“œë¥¼ êµ¬í˜„í• ë•Œ oauth2Login()ì—ì„œë¶€í„° ì‹œì‘ëœë‹¤.</p>\n<ul>\n<li>\n<p>oauth2Loginìœ¼ë¡œ ë¶™ëŠ” ë©”ì†Œë“œëŠ”</p>\n<ul>\n<li>authorizationEndpoint: ì•¡ì„¸ìŠ¤í† í°ì„ ì¸ì¦í•˜ëŠ” ê³³..?</li>\n<li>authorizationRequestRepository: ì¸ì¦ìš”ì²­ì„ ì €ì¥í•  ì €ì¥ì†Œ..?</li>\n<li>redirectionEndpoint: OAuth2 ë¡œê·¸ì¸ì„ ì„±ê³µí•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë  ê³³</li>\n<li>\n<p>userInfoEndpoint: OAuth2 ì¸ì¦í›„ ì‚¬ìš©ìì •ë³´ë¥¼ loadí•˜ëŠ” ê³³</p>\n<ul>\n<li>OAuth2UserService</li>\n</ul>\n</li>\n<li>successHandler: ìœ ì €ì •ë³´ê¹Œì§€ ì„±ê³µì ìœ¼ë¡œ loadë˜ë©´ ì‹¤í–‰ë  í•¸ë“¤ëŸ¬</li>\n<li>FailureHandler: ë„ì¤‘ Exceptionì„ ë°›ì„ í•¸ë“¤ëŸ¬</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>ëŒ€~ì¶© ì´ëŸ°ë° ë§ëŠ” ì§€ ì˜ ëª¨ë¥´ê²Ÿë‹¤. ì¢€ ë” ì½”ë“œë¥¼ ë’¤ì§‘ì–´ê¹Œë´ì•¼ë ê±°ê°€í‹ˆ.</p>\n<h5 id=\"oauth2userservice\"><a href=\"#oauth2userservice\" aria-label=\"oauth2userservice permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth2UserService</h5>\n<p>í† í°ì„ ë°œê¸‰ë°›ê³ , ìœ ì €ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ê³¼ì •ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ë¡œ ë³´ì¸ë‹¤.</p>\n<ul>\n<li>OAuth2ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ë©´, í•´ë‹¹ ì„œë¹„ìŠ¤ë¡œ ìœ ì €ì •ë³´ ì¡°íšŒ - ì‹œíë¦¬í‹°ì„¤ì •ì—ì„œ userInfoEndpointì— ì¶”ê°€í•œ ê²ƒìœ¼ë¡œ ì´ë ‡ê²Œ ì¶”ì¸¡ë˜ì–´ì§.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomOAuth2UserService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">DefaultOAuth2UserService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuth2User</span> <span class=\"token function\">loadUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2UserRequest</span> userRequest<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">OAuth2AuthenticationException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">OAuth2User</span> oAuth2User <span class=\"token operator\">=</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadUser</span><span class=\"token punctuation\">(</span>userRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">processOAuth2User</span><span class=\"token punctuation\">(</span>userRequest<span class=\"token punctuation\">,</span> oAuth2User<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalAuthenticationServiceException</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">.</span><span class=\"token function\">getCause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OAuth2User</span> <span class=\"token function\">processOAuth2User</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2UserRequest</span> oAuth2UserRequest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2User</span> oAuth2User<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">OAuth2UserInfo</span> oAuth2UserInfo <span class=\"token operator\">=</span> <span class=\"token class-name\">OAuth2UserInfoFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getOAuth2UserInfo</span><span class=\"token punctuation\">(</span>oAuth2UserRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getClientRegistration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRegistrationId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> oAuth2User<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuth2AuthenticationProcessingException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Email not found from OAuth2 provider\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userOptional <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByEmail</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> user<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>userOptional<span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            user <span class=\"token operator\">=</span> userOptional<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuthProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>oAuth2UserRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getClientRegistration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRegistrationId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuth2AuthenticationProcessingException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Looks like you're signed up with \"</span>\n                        <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" account, Please use your \"</span> <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" account to login\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            user <span class=\"token operator\">=</span> <span class=\"token function\">updateExistingUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> oAuth2UserInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            user <span class=\"token operator\">=</span> <span class=\"token function\">registerNewUser</span><span class=\"token punctuation\">(</span>oAuth2UserRequest<span class=\"token punctuation\">,</span> oAuth2UserInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">UserPrincipal</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> oAuth2User<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">User</span> <span class=\"token function\">registerNewUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2UserRequest</span> oAuth2UserRequest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2UserInfo</span> oAuth2UserInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">provider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuthProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>oAuth2UserRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getClientRegistration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRegistrationId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">providerId</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">email</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">imageUrl</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getImageUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">User</span> <span class=\"token function\">updateExistingUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> existingUser<span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2UserInfo</span> oAuth2UserInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        existingUser<span class=\"token punctuation\">.</span><span class=\"token function\">setName</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        existingUser<span class=\"token punctuation\">.</span><span class=\"token function\">setImageUrl</span><span class=\"token punctuation\">(</span>oAuth2UserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getImageUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>existingUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>DefaultOAuth2UserServiceìƒì†, ë¶€ëª¨í´ë˜ìŠ¤ì˜ loadUserì‹¤í–‰, ë¶ˆëŸ¬ë“¤ì¸ Userë¥¼ ê°€ì§€ê³  ì»¤ìŠ¤í„°ë§ˆì´ì§•</p>\n</li>\n<li>\n<p>ì–´ë– í•œ ê²ƒì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í–ˆëŠ”ê°€.</p>\n<ul>\n<li>ìœ ì €ì •ë³´ì—ì„œ ì´ë©”ì¼ì„ ê°€ì§€ê³  DBì¡°íšŒ</li>\n<li>ìœ ì €ê°€ ì¡´ì¬í•˜ê³  ì¡°íšŒëœ ê²ƒê³¼ ë¡œê·¸ì¸ ì„±ê³µí•œ ê²ƒê³¼ provider(google, facebookë“±)ë¥¼ ë¹„êµ, </li>\n<li>oauthëŠ” ë‹¬ë¼ë„ ì´ë©”ì¼ì´ ê°™ì„ ìˆ˜ ìˆìŒ. (í•„ìëŠ” google, github ì´ë©”ì¼ì´ ê°™ì•„ githubê³„ì •ì„ ëª»ë§Œë“¬.)</li>\n<li>í•´ë‹¹ ìœ ì €ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥.</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"jwtí† í°-ê²€ì¦-ë°-ë°œê¸‰-ì²˜ë¦¬tokenauthenticationfilter\"><a href=\"#jwt%ED%86%A0%ED%81%B0-%EA%B2%80%EC%A6%9D-%EB%B0%8F-%EB%B0%9C%EA%B8%89-%EC%B2%98%EB%A6%ACtokenauthenticationfilter\" aria-label=\"jwtí† í° ê²€ì¦ ë° ë°œê¸‰ ì²˜ë¦¬tokenauthenticationfilter permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JWTí† í° ê²€ì¦ ë° ë°œê¸‰ ì²˜ë¦¬(TokenAuthenticationFilter)</h5>\n<ul>\n<li>ë°œê¸‰ë°›ì€ í† í°ì´ ìœ íš¨í•œ í† í°ì¸ì§€ í™•ì¸í•´ì£¼ëŠ” í•„í„°</li>\n</ul>\n<p>ì´ í•„í„°ëŠ” UsernamePasswordAuthenticationFilter í´ë˜ìŠ¤ ì•ì— ë‚˜ì˜¤ê²Œ í•˜ì—¬ ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ë³´ë‹¤ ë” ì•ì„œ OAuth2ë¡œê·¸ì¸ì„ í™•ì¸í•˜ê² ë‹¤ëŠ”(?) í•„í„°</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TokenAuthenticationFilter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OncePerRequestFilter</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">TokenProvider</span> tokenProvider<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CustomUserDetailsService</span> customUserDetailsService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Logger</span> logger <span class=\"token operator\">=</span> <span class=\"token class-name\">LoggerFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TokenAuthenticationFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doFilterInternal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">FilterChain</span> chain<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ServletException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">getJwtFromRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasText</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> tokenProvider<span class=\"token punctuation\">.</span><span class=\"token function\">validateToken</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Long</span> userId <span class=\"token operator\">=</span> tokenProvider<span class=\"token punctuation\">.</span><span class=\"token function\">getUserIdFromToken</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">UserDetails</span> userDetails <span class=\"token operator\">=</span> customUserDetailsService<span class=\"token punctuation\">.</span><span class=\"token function\">loadUserById</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span> authenticationToken <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span><span class=\"token punctuation\">(</span>userDetails<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userDetails<span class=\"token punctuation\">.</span><span class=\"token function\">getAuthorities</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                authenticationToken<span class=\"token punctuation\">.</span><span class=\"token function\">setDetails</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAuthenticationDetailsSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildDetails</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">SecurityContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAuthentication</span><span class=\"token punctuation\">(</span>authenticationToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ìœ ì € ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        chain<span class=\"token punctuation\">.</span><span class=\"token function\">doFilter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getJwtFromRequest</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> bearerToken <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasText</span><span class=\"token punctuation\">(</span>bearerToken<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> bearerToken<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> bearerToken<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>Authorization í—¤ë”ë¡œ ë“¤ì–´ì˜¨ JWTí† í°ì„ ê²€ì¦.</li>\n<li>ìœ ì € idë¡œ ìœ ì €ì •ë³´ë¥¼ ê°€ì ¸ì˜´(DBì—ì„œ ê°€ì ¸ì˜¤ê²Œ ë˜ì–´ìˆìŒ.)</li>\n<li>ì¸ì¦í† í°ì„ ë§Œë“¬(UsernamePasswordAuthenticationToken)</li>\n<li>í•´ë‹¹ í† í°ì„ í†µí•´ ì‹œíë¦¬í‹° contextì— ì¸ì¦ë˜ì—ˆë‹¤!ëŠ” ê²ƒì„ ì ìš©ì‹œì¼œ ë‹¤ìŒ UsernamePassword ì¸ì¦í•„í„°ì— ë§‰íˆì§€ì•Šê²Œí•¨.</li>\n</ol>","headings":[{"value":"OAuth2 ì¸ì¦ë°©ì‹ì˜ ì´í•´","depth":2},{"value":"OAuth2ì˜ ì¸ì¦ë°©ì‹ Flow","depth":3},{"value":"Spring Bootì—ì„œ êµ¬í˜„í•˜ê¸°.","depth":3},{"value":"êµ¬í˜„í•˜ê¸° ì „ì— ì •ë¦¬í•  ìš©ì–´ë“¤","depth":4},{"value":"êµ¬í˜„","depth":4},{"value":"ì‹œíë¦¬í‹° ì„¤ì •","depth":5},{"value":"OAuth2UserService","depth":5},{"value":"JWTí† í° ê²€ì¦ ë° ë°œê¸‰ ì²˜ë¦¬(TokenAuthenticationFilter)","depth":5}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/blog/2019-04-30-oauth2-ì¸ì¦ë°©ì‹ì˜-ì´í•´/","previous":{"node":{"id":"6f11d351-1614-53b4-9b4d-af4788d26426","frontmatter":{"title":"ì¹´ì¹´ì˜¤í”„ë Œì¦ˆ ì»¬ëŸ¬ë§ë¶ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œí’€ì´ - í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ Level 3 (í…ŒìŠ¤íŠ¸ O, ì±„ì  X)","category":"algorithm","date":"2019-04-10","tags":["programmers","algorithm"]},"fields":{"slug":"/posts/blog/algorithm/2019-04-10-ì¹´ì¹´ì˜¤í”„ë Œì¦ˆì»¬ëŸ¬ë§ë¶-ì•Œê³ ë¦¬ì¦˜-ë¬¸ì œí’€ì´/"}}},"next":{"node":{"id":"ec9138b1-7e06-5137-bf86-de0132420c8a","frontmatter":{"title":"Spring Tiles ì ìš©","category":"spring","date":"2019-05-02","tags":["Spring","DI","tiles"]},"fields":{"slug":"/posts/blog/spring/2019-05-02-spring-tiles-ì ìš©/"}}}}}