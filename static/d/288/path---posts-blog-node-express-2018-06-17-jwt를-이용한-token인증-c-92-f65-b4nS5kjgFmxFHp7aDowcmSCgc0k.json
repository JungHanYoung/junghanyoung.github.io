{"data":{"markdownRemark":{"frontmatter":{"title":"JWT를 이용한 token 인증 구현해보기."},"html":"<h1>jwt를 이용한 token인증</h1>\n<h2>개요</h2>\n<p>React를 공부하다보니 PWA(Progressive Web Application)을 만들기 위해서는 서버 사이드 렌더링이 아닌 REAST API를 호출하여 데이터를 렌더링하는 방식을 많이 사용하는 것 같다. 서버 사이드 렌더링도 있는데 너무 어려워 보임 ):</p>\n<p>웹 어플리케이션에서 빠질 수 없는 것이 인증처리..</p>\n<p>보통 인증처리는 Session을 사용할 수 있지만 이는 REST API가 지향하는 방식이 아니라고 한다. </p>\n<p>그래서 REST API는 Session인증 대신 Token인증 방식을 이용한다.</p>\n<p>express와 sequelize를 활용, jwt를 이용해 토큰을 응답받는 API를 만든다.</p>\n<hr>\n<h2>API 설계</h2>\n<ul>\n<li>(POST)    /api/user/login</li>\n<li>(GET)     /api/user/me</li>\n</ul>\n<h2>1. LOGIN - 인증토큰 요청</h2>\n<ul>\n<li>username과 password로 로그인.</li>\n<li>token을 리턴한다.</li>\n</ul>\n<p>Request</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    &quot;username&quot;: &quot;test&quot;,\n    &quot;password&quot;: &quot;testpw&quot;\n}</code></pre></div>\n<p>Response</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    &quot;success&quot;: true,\n    &quot;token&quot;: &quot;&lt;토큰&gt;&quot;\n}</code></pre></div>\n<h2>2. ME</h2>\n<ul>\n<li>로그인시 받은 token을 header의 x-access-token을 보냄.</li>\n<li>x-access-token이 없을 시 Error 리턴</li>\n<li>token을 해독하여 유저 정보 리턴</li>\n</ul>\n<p>Request</p>\n<ul>\n<li>N/A</li>\n</ul>\n<p>Response</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    success: true,\n    user: {\n        id: ....,\n        username: ...,\n        iat: ...,\n        exp: ...,\n    }\n}</code></pre></div>\n<hr>\n<h2>프로젝트 생성</h2>\n<h3>프로젝트 구조</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;Project&gt;\n- node_modules\n- .babelrc\n- package.json\n- server.js\n- models\n - index.js\n - user.js\n- routes\n - index.js\n - user.js</code></pre></div>\n<h3>모듈 설치</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">yarn add express sequelize mysql2 bcryptjs jsonwebtoken\nyarn add -D babel-core babel-preset-env babel-cli</code></pre></div>\n<ul>\n<li>express - 웹 서버</li>\n<li>sequelize - 데이터베이스 ORM</li>\n<li>mysql2 - 데이터베이스 커넥터</li>\n<li>bcryptjs - SHA 암호화</li>\n<li>jsonwebtoken(JWT) - 토큰 암호화\n<br/><br/></li>\n<li>babel-core, babel-preset-env, babel-cli - ES6 컴파일</li>\n</ul>\n<hr>\n<h2>서버, 데이터 모델 및 라우터</h2>\n<h3>서버</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// server.js\nimport express from &#39;express&#39;;\n\nimport models from &#39;./models&#39;;\nimport apiRouter from &#39;./routes&#39;;\n\nconst app = express();\n\napp.use(express.json());\n\napp.use(&#39;/api&#39;, apiRouter);\n\nmodels.sequelize.sync().then(() =&gt; {\n\tapp.listen(3000, () =&gt; console.log(&#39;Server is listening on port&#39;, 3000));\n});</code></pre></div>\n<h3>데이터 모델</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// models/index.js\nimport Sequelize from &#39;sequelize&#39;;\nimport path from &#39;path&#39;;\n\nconst sequelize = new Sequelize(&#39;testdb1&#39;, &#39;root&#39;, &#39;1234&#39;, {\n\tdialect: &#39;mysql&#39;,\n\thost: &#39;localhost&#39;\n});\n\nconst models = {\n\tUser: sequelize.import(path.join(__dirname, &#39;/user&#39;))\n};\n\nmodels.sequelize = sequelize;\nmodels.Sequelize = Sequelize;\n\nexport default models;\n\n// models/user.js\nexport default (sequelize, DataTypes) =&gt; {\n\tconst User = sequelize.define(&#39;user&#39;, {\n\t\tid: {\n\t\t\ttype: DataTypes.INTEGER,\n\t\t\tprimaryKey: true,\n\t\t\tautoIncrement: true\n\t\t},\n\t\tusername: {\n\t\t\ttype: DataTypes.STRING,\n\t\t\tunique: true\n\t\t},\n\t\tpassword: {\n\t\t\ttype: DataTypes.STRING\n\t\t}\n\t});\n\n\treturn User;\n};</code></pre></div>\n<ul>\n<li>sequelize를 이용, mysql과 연동</li>\n<li>user 스키마를 만듬</li>\n</ul>\n<h3>라우터</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// routes/index.js\nimport express from &#39;express&#39;;\n\nimport userRouter from &#39;./user&#39;;\n\nconst router = express.Router();\n\nrouter.use(&#39;/user&#39;, userRouter);\n\nexport default router;</code></pre></div>\n<br/>\n<h2>User Router*</h2>\n<ol>\n<li>username와 password로 로그인 (POST - /api/user/login)</li>\n<li>로그인 정보가 유효하면 토큰 응답 O</li>\n<li>로그인 정보가 유효하지 않을 시 토큰 응답 X</li>\n<li>Client는 로그인시 받은 토큰을 HTTP통신시 헤더에 넣어 서버로부터 인증을 받는다. (GET - /api/user/me)</li>\n</ol>\n<h3>로그인</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// routes/user.js\nimport express from &#39;express&#39;;\nimport models from &#39;../models&#39;;\nimport bcrypt from &#39;bcryptjs&#39;;\nimport jwt from &#39;jsonwebtoken&#39;;\n\nconst router = express.Router();\n\n// POST - /api/user/login\n// Body - username, password\n// Response - success여부, token?\nrouter.post(&#39;/login&#39;, (req, res) =&gt; {\n\tconst { username, password } = req.body;\n\n    // username에 해당하는 정보 찾기\n\tmodels.User\n\t\t.findOne({\n\t\t\twhere: {\n\t\t\t\tusername\n\t\t\t}\n\t\t})\n\t\t.then((result) =&gt; {\n            // 정보 유무 체크\n            if (!result) {\n\t\t\t\treturn res.status(404).json({\n\t\t\t\t\tsuccess: false\n\t\t\t\t});\n\t\t\t}\n            // 비밀번호 비교\n\t\t\tconst valid = bcrypt.compareSync(password, result.password);\n            // 로그인 정보 유효함.\n\t\t\tif (valid) {\n\t\t\t\tconst user = result.dataValues;\n\t\t\t\tdelete user.password;\n\t\t\t\tconst token = jwt.sign(user, &#39;Secret Key&#39;);\n\t\t\t\tres.json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\ttoken\n\t\t\t\t});\n            // 비밀번호가 틀림\n\t\t\t} else {\n\t\t\t\tres.status(403).json({\n\t\t\t\t\tsuccess: false\n\t\t\t\t});\n\t\t\t}\n\t\t})\n        // 에러 감지\n\t\t.catch((err) =&gt; {\n\t\t\tconsole.error(err);\n\t\t\tres.status(500).json({\n\t\t\t\tsuccess: false\n\t\t\t});\n\t\t});\n});</code></pre></div>\n<ul>\n<li>jwt.sign함수 - plain obejct로 문자열 토큰을 만든다.</li>\n</ul>\n<h3>자신의 프로필</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// GET - /api/user/me\n// Body - N/A\n// Response - 유저정보\nrouter.get(&#39;/me&#39;, (req, res) =&gt; {\n\tconst token = req.headers[&#39;x-access-token&#39;];\n\n\tconst userInfo = jwt.verify(token, &#39;Secret Key&#39;);\n\n\tres.json(userInfo);\n});\n\nexport default router;</code></pre></div>\n<ul>\n<li></li>\n<li>jwt.verify함수 - 암호화된 토큰을 검증, 토큰을 해독한 값을 리턴</li>\n</ul>\n<br/>\n<hr>\n<br/>\n<h2>결과</h2>\n<p>로그인시</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;Request&gt;\nPOST - /api/user/login\nheaders - None\nbody -\n{\n\t&quot;username&quot;: &quot;test&quot;,\n\t&quot;password&quot;: &quot;testpw&quot;\n}\n-&gt;\n&lt;Response&gt;\n{\n    &quot;success&quot;: true,\n    &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJ0ZXN0IiwiY3JlYXRlZEF0IjoiMjAxOC0wNi0xN1QwNjoxOTo1NC4wMDBaIiwidXBkYXRlZEF0IjoiMjAxOC0wNi0xN1QwNjoxOTo1NC4wMDBaIiwiaWF0IjoxNTI5MjE5NjM5fQ.2ZkBkxat8wVSzo29MzisrQLt1MXoypfUDM81ecW6ACg&quot;\n}</code></pre></div>\n<p>로그인 후 자신의 프로필</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;Request&gt;\nGET - /api/user/me\nheaders - \n{\n    x-access-token: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJ0ZXN0IiwiY3JlYXRlZEF0IjoiMjAxOC0wNi0xN1QwNjoxOTo1NC4wMDBaIiwidXBkYXRlZEF0IjoiMjAxOC0wNi0xN1QwNjoxOTo1NC4wMDBaIiwiaWF0IjoxNTI5MjE5NjM5fQ.2ZkBkxat8wVSzo29MzisrQLt1MXoypfUDM81ecW6ACg&quot;\n}\nbody - None\n-&gt;\n&lt;Response&gt;\n{\n    &quot;id&quot;: 1,\n    &quot;username&quot;: &quot;test&quot;,\n    &quot;createdAt&quot;: &quot;2018-06-17T06:19:54.000Z&quot;,\n    &quot;updatedAt&quot;: &quot;2018-06-17T06:19:54.000Z&quot;,\n    &quot;iat&quot;: 1529219639\n}</code></pre></div>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/blog/node-express/2018-06-17-jwt를-이용한-token인증/","previous":{"node":{"id":"fb40917b-43ed-5efd-b4c8-0dcf90fb47bc","frontmatter":{"title":"데이터베이스 인덱스는 뭘까..?","category":"database","date":"2018-06-17"},"fields":{"slug":"/posts/blog/database/2018-06-22-데이터베이스-인덱스(Index)/"}}},"next":{"node":{"id":"dcd7f1a5-872d-50df-8417-bd894d2601df","frontmatter":{"title":"JDBC -> DBCP -> MyBatis","category":"spring","date":"2018-06-17 07:49:00 +0300"},"fields":{"slug":"/posts/blog/spring/2018-06-18-JDBC,-DBCP,-그리고-MyBatis/"}}}}}